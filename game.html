<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    
    <body>
        <script>
            
            const interval = 1000;
            
            var intervalId = -1;
            
            var gameCode = "";
            var twoPlayer = false;
            var playerId = -1;
            var iHaveMoved = false;
            var iCanMove = false;
            var gameOver = false;
            function SendInput(x,b)
            {
                console.log("run");
                
                if (gameOver)
                {
                    DisplayMessgae("This game is over, you can refresh this page and use a new code to join.");
                    return;
                }
                
                if (gameCode.length === 0 || !twoPlayer)
                {
                    DisplayMessage("You must create or join a game with another player before you can play.");
                    console.log("0");
                    return;
                }
                
                if (!iCanMove)
                {
                    DisplayMessage("Please wait for your turn.");
                    console.log("1");
                    return;
                }
                
                if (iHaveMoved)
                {
                    DisplayMessage("Please wait for your turn");
                    console.log("2");
                    return;
                }
                
                if (b.innerHTML !== "[ ]")
                {
                    console.log("3");
                    return;
                }
                
                console.log("4");
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log("5");
                        console.log(this.responseText);
                        DisplayMessage("Wait for the other player to move...");
                        UpdateGame(JSON.parse(this.responseText).game);
                        
                    }
                };
                xhttp.open("POST", "https://ina-fan-game.herokuapp.com/sendInput?playerId="+playerId+"&box="+x+"&code="+gameCode, true);
                xhttp.send();
            }
            
            function UpdateGame(gameData)
            {  
                for (var i = 0; i < gameData.box.length; i++)
                {
                    var box = document.getElementById("b"+(i+1));
                    
                    if (gameData.box[i] == 0)
                    {
                        box.innerHTML = "[ ]";
                    }
                    else if (gameData.box[i] == 1)
                    {
                        box.innerHTML = "[X]";
                    }
                    else if (gameData.box[i] == 2)
                    {
                        box.innerHTML = "[O]";
                    }
                }
                
                if (gameData.turn == playerId)
                {
                    if (iCanMove = false)
                    {
                        iHaveMoved = false;
                    }
                    iCanMove = true;
                    DisplayMessage("Now is your turn!");
                }
                else
                {
                    iCanMove = false;
                }
                console.log("game"+gameData.win);
                if (gameData.win == playerId)
                {
                    DisplayMessage("You won!");
                    gameOver = true;
                }
                else if(gameData.win != 0)
                {
                    DisplayMessage("You lose!");
                    gameOver = true;
                }
                
                
            }
            
            function RegularUpdate()
            {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200)
                    {
                        var json = JSON.parse(this.responseText);
                       
                        var gameData = "";
                        
                        if (typeof json.game == "string")
                        {
                            gameData = JSON.parse(json.game);
                        }
                        else
                        {
                            gameData = json.game;
                        }
                        
            
                        if (!twoPlayer && gameData.players == "2")
                        {
                            DisplayMessage("Two player is in the game, you may start now!");
                            twoPlayer = true;
                            UpdateGame(gameData);
                            
                        }
                        else if(twoPlayer)
                        {
                            UpdateGame(gameData);
                        }
                        
                        
                    }
                };
                xhttp.open("POST", "https://ina-fan-game.herokuapp.com/update?code="+gameCode, true);
                xhttp.send();
            }
            
            function DisplayMessage(message)
            {
                document.getElementById("message").innerHTML = message;
            }
            
            function JoinGame()
            {
                var code = document.getElementById("gameCode").value;
                
                if (code.length === 0)
                {
                    DisplayMessage("Please enter a code");
                    return;
                }
                
                if (gameCode == code)
                {
                    DisplayMessage("You're the creator of this game, please wait for your friend to join.");
                    return;
                }
        
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        var json = JSON.parse(this.responseText);
                        if (json.status == "FULL")
                        {
                            DisplayMessage("This game already has 2 player.");
                        }
                        else if (json.status == "CREATED")
                        {
                            if (gameCode.length == 0)
                            {
                                playerId = 1;
                                gameCode = code;
                                DisplayMessage("You have created a game, you will be notified when another player join the game.");
                                document.getElementById("joinGame").style.display = "none";
                                intervalId = setInterval(RegularUpdate, interval);
                            }
                        }
                        else if (json.status == "JOINED")
                        {
                            playerId = 2;
                            gameCode = code;
                            DisplayMessage("You have joined a game.");
                            document.getElementById("joinGame").style.display = "none";
                            intervalId = setInterval(RegularUpdate, interval);
                        }
                    }
                };
                xhttp.open("POST", "https://ina-fan-game.herokuapp.com/join?code="+code, true);
                xhttp.send();
            }
            
        </script>
        <button id="b1" onclick="SendInput(1,this)">[ ]</button><button id="b2" onclick="SendInput(2,this)">[ ]</button><button id="b3" onclick="SendInput(3,this)">[ ]</button>
        <br>
        <button id="b4" onclick="SendInput(4,this)">[ ]</button><button id="b5" onclick="SendInput(5,this)">[ ]</button><button id="b6" onclick="SendInput(6,this)">[ ]</button>
        <br>
        <button id="b7" onclick="SendInput(7,this)">[ ]</button><button id="b8" onclick="SendInput(8,this)">[ ]</button><button id="b9" onclick="SendInput(9,this)">[ ]</button>
        <br>
        <br>
        <br>
        <p id="message"></p>
        <br>
    <div id="joinGame">
        <p>You can create or join a game by entering a game code, each game code can be used by two players only.</p>
        <button onclick="JoinGame()">Join Game</button>
        <input type="text" id="gameCode" placeholder="Enter your game code here...">
    </div>
    </body>
</html>
